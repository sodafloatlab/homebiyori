# バックエンド学習ガイド: 03. tree_service

このドキュメントでは、`tree_service` の役割と実装について解説します。

## サービスの役割

`tree_service`は、このアプリケーションのコア機能の一つである**「木」の状態管理**を担当するサービスです。ユーザーの日々の入力（メッセージ数や文字数）に応じて木を成長させ、その状態を記録・管理します。

`user_service`と同様に、基本的なCRUD（作成、読み取り、更新、削除）操作が中心となりますが、こちらはより具体的なビジネスロジック（どういう条件で木が成長するかなど）と密接に関連しています。

---

## ファイル解説

### 1. `models.py` - データ構造とビジネスロジック

このファイルは、`tree_service`が扱う主要なデータである**「木」**と**「実」**に関するデータ構造と、それに関連するビジネスロジックを定義しています。

#### 型定義と設定値

ファイルの冒頭では、このサービスで使われる様々な「型」や「設定」が定義されています。

- **`TreeStage = Literal[0, 1, 2, 3, 4, 5]`**: 木の成長段階を0から5の整数に限定する厳密な型定義です。
- **`Enum`クラス**: AIキャラクター、感情、木のテーマカラーなど、決まった選択肢の中から値を選ぶフィールドを定義します。
- **`TREE_STAGE_CONFIG`**: 木の成長段階ごとの設定（名前、必要文字数など）をまとめた設定辞書です。ロジックと設定値を分離し、保守性を高めています。

#### Pydanticモデル

主に3つの系統のモデルが定義されています。

1.  **木の状態・成長に関するモデル** (`TreeStatus`, `TreeGrowthInfo`): 現在の木の状態や、成長した瞬間の情報を表現します。
2.  **実（褒めメッセージ）に関するモデル** (`FruitInfo`, etc.): 一つ一つの「実」が持つ情報や、関連するAPIのデータ形式を定義します。
3.  **成長履歴に関するモデル** (`GrowthHistoryItem`, etc.): 「いつ、どの段階に到達したか」というマイルストーンの履歴を表現します。

#### ユーティリティ関数

ファイルの末尾には、ビジネスロジックを計算するためのヘルパー関数が定義されています。

- **`calculate_tree_stage(...)`**: 累計文字数から現在の成長段階を計算します。
- **`get_characters_to_next_stage(...)`**: 次のステージまでの必要文字数を計算します。
- **`can_generate_fruit(...)`**: 「実は1日に1回まで」というルールを判定します。

`user_service`の`models.py`と比較して、データの構造定義に加え、**ドメイン固有のビジネスロジック**が多く含まれているのが特徴です。
