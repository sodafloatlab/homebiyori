# 課金サービス (billing_service) 解説

## 1. 概要

`billing_service`は、外部の決済プラットフォームであるStripeを利用して、アプリケーションのサブスクリプション（月額・年額課金）機能を提供するマイクロサービスです。

ユーザーのプラン登録、支払い、契約管理といった一連の課金フローを、安全かつ効率的に処理することを目的とします。

## 2. アーキテクチャと責務

本サービスは、責務に応じて明確にコンポーネントが分離されています。

- **`main.py` (APIエンドポイント層):**
  - フロントエンドからのHTTPリクエスト（例: 「プランに申し込みたい」「課金情報を管理したい」）を受け付けるAPIサーバーです。
  - ユーザー認証を行い、リクエスト内容に応じて後述の`stripe_client`や`database`を呼び出す司令塔の役割を担います。

- **`stripe_client.py` (Stripe連携層):**
  - StripeのAPIと直接通信するロジックをカプセル化（一つにまとめる）したクライアントです。
  - 「Stripeで顧客を作成する」「決済ページを作成する」といった具体的な処理をすべて担当します。
  - これにより、`main.py`などの上位層はStripeの複雑な仕様を意識することなく、簡潔なメソッド呼び出しでStripeの機能を利用できます。

- **`database.py` (データ永続化層):**
  - Stripeから取得した情報（`customer_id`, `subscription_id`など）や、ユーザーの課金状態をアプリケーションのデータベース（DynamoDB）に保存・読み込みします。
  - アプリケーション固有のデータ管理を担当します。

- **`models.py` (データモデル層):**
  - APIリクエスト/レスポンスのデータ構造や、データベースに保存するデータの形式をPydanticモデルとして定義します。これにより、データの型や構造が保証され、開発の安全性が向上します。

## 3. Stripeの主要概念とコード実装

Stripeが提供する様々な機能を組み合わせることで、課金システムを構築しています。

| Stripe概念 | 概要 | コードでの主な実装箇所 | 必要性 |
| :--- | :--- | :--- | :--- |
| **Customer (顧客)** | 支払いを行うユーザーを識別するオブジェクト。 | `stripe_client.get_or_create_customer` | すべての課金情報（サブスクリプション、支払い方法）を紐付ける中心的な存在。 |
| **Product / Price** | 提供するサービス（商品）と、その価格設定。 | Stripeダッシュボードで事前作成。コードでは`get_stripe_price_id`でIDを呼び出す。 | 「何を」「いくらで」請求するのかを定義する。 |
| **Checkout Session** | Stripeがホストする安全な決済ページセッション。 | `main.py`の`/checkout-session`エンドポイント → `stripe_client.create_checkout_session` | ユーザーが安全に支払いを行うためのUI。カード情報を自社で扱わないことでセキュリティを担保する。 |
| **Subscription** | 顧客と商品を紐付け、定期的な支払いを自動生成する仕組み。 | 決済成功時にStripeが自動作成。`stripe_client.cancel_subscription`でキャンセル処理。 | 月額・年額課金のような継続的な支払いを自動化する。 |
| **Billing Portal** | 顧客自身が支払い方法の変更や解約を行えるStripeホストの管理ページ。 | `main.py`の`/portal`エンドポイント → `stripe_client.create_billing_portal_session` | 複雑な顧客管理機能を自前で開発するコストを大幅に削減する。 |
| **Webhook** | Stripe側でイベントが発生した際に、アプリに非同期で通知する仕組み。 | `webhook_service`（別サービス）で受信。`stripe_client.verify_webhook_signature`で署名検証。 | 支払いの成功・失敗などをリアルタイムでアプリに反映させ、DBの状態を最新に保つ。 |

## 4. エンドツーエンドの課金フロー (UIからStripeまで)

ユーザーがトライアルプランから有料プランにアップグレードする際の、UIからバックエンド、Stripeまでを含めた一連の流れです。

#### ステップ1: 課金プランの表示と選択

1.  **UI (ユーザー操作):** ユーザーはアプリ内の課金ページ (`/billing/subscribe`) で希望のプラン（例: 月額プラン）を選択します。
2.  **フロントエンド:** ボタンのクリックイベントが発火し、`BillingService.ts`を通じてバックエンドAPIを呼び出します。
3.  **APIリクエスト (FE → BE):** `/api/billing/checkout-session`エンドポイントに、選択されたプランIDを添えてPOSTリクエストが送信されます。

#### ステップ2: 決済ページの生成とリダイレクト

4.  **バックエンド:** `main.py`がリクエストを受け取り、`stripe_client.py`に処理を移譲します。
5.  **Stripe連携 (BE ⇔ Stripe):** `stripe_client.py`がStripe APIを呼び出し、決済ページ（Checkout Session）を作成します。
6.  **フロントエンドへの応答:** バックエンドはStripeから受け取った決済ページURLをフロントエンドに返します。フロントエンドはユーザーをそのURLにリダイレクトさせます。

#### ステップ3: 支払いと状態同期

7.  **UI (Stripe決済ページ):** ユーザーはStripeの安全なページでクレジットカード情報などを入力し、支払いを確定します。
8.  **支払い完了とリダイレクト:** 支払いが成功すると、Stripeはユーザーを事前に指定された成功ページ (`/billing/success`) にリダイレクトします。
9.  **非同期での状態更新 (Webhook):**
    - ユーザーのリダイレクトと**同時に**、Stripeはバックエンドの`webhook_service`に「決済完了」のイベント通知を送信します。
    - `webhook_service`は通知を検証し、`billing_service`のデータベースを更新して、ユーザーのステータスを「プレミアム会員」に変更します。

#### ステップ4: 課金状態の確認

10. **UI (ユーザー操作):** 後日、ユーザーがアプリの「アカウント設定」ページを開きます。
11. **フロントエンド:** ページのレンダリング時に、バックエンドに現在のサブスクリプション状態を問い合わせるAPIを呼び出します。
12. **APIリクエスト (FE → BE):** `/api/billing/subscription`エンドポイントにGETリクエストが送信されます。
13. **バックエンド:** `database.py`を通じてDBから最新のユーザー情報を取得し、フロントエンドに返します。
14. **UIへの反映:** フロントエンドは受け取った情報（現在のプラン、次の請求日など）を画面に表示します。

## 5. フロントエンドとの連携

フロントエンドとバックエンドは、APIを介して明確に役割分担しています。

- **フロントエンド (`frontend/src`):**
  - **責務:** UIの表示、ユーザー操作の受付、バックエンドAPIの呼び出し、結果の表示。
  - **主要ファイル:**
    - `app/billing/subscribe/page.tsx`: 課金プラン選択ページ。
    - `lib/services/BillingService.ts`: バックエンドの課金APIと通信するためのロジックをまとめたクラス。
    - `lib/hooks/billing/useBilling.ts`: `BillingService`をReactコンポーネントから使いやすくするためのカスタムフック。UIコンポーネントのロジックを簡潔に保ちます。

- **バックエンド (`backend/services/billing_service`):**
  - **責務:** ビジネスロジックの実行、Stripeとの安全な通信、データベースへの永続化。

この連携により、ユーザーにはシームレスな課金体験を提供しつつ、開発者にとっては安全でメンテナンス性の高いシステムを実現しています。
