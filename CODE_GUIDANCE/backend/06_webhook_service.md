### `webhook_service` 解説

このサービスは、StripeからのWebhookイベントを安全かつ効率的に処理するためのバックエンドサービスです。主な責務は、サブスクリプションの同期と決済履歴の保存です。

---

#### **処理フローと難易度**

| No. | ファイル/モジュール | 概要 | 行数 (概算) | 難易度 |
| :-- | :--- | :--- | :--- | :--- |
| 1 | `handler.py` | **Lambdaエントリーポイント**。API GatewayからのリクエストをFastAPIアプリに中継する。 | 50 | ★☆☆☆☆ |
| 2 | `main.py` | **FastAPIアプリケーション**。ルーティング、ミドルウェア、例外処理など全体設定を管理。 | 80 | ★★☆☆☆ |
| 3 | `handlers/stripe_handler.py` | **Webhookエンドポイント**。Stripe署名を検証し、リクエストをサービス層に渡す。 | 70 | ★★★☆☆ |
| 4 | `services/stripe_service.py` | **ビジネスロジック**。イベント内容に基づき、DB更新やプロファイル同期などの実処理を行う。 | 150 | ★★★★☆ |
| 5 | `database.py` | **データアクセス層**。DynamoDBとのやり取りを抽象化し、CRUD操作を提供する。 | 120 | ★★★☆☆ |
| 6 | `models/` | **データモデル**。Pydanticを使い、StripeデータやDBスキーマを型安全に定義する。 | 250 | ★★★☆☆ |
| 7 | `core/config.py` | **設定管理**。環境変数から設定を読み込み、アプリケーション全体で利用可能にする。 | 60 | ★★☆☆☆ |

---

#### **各モジュールの詳細解説**

**1. `handler.py` (難易度: ★☆☆☆☆)**
*   **役割**: AWS Lambdaの実行エントリーポイント。
*   **機能**:
    *   `Mangum`ライブラリを使い、受信したLambdaイベントをFastAPIが解釈できるASGI形式に変換します。
    *   リクエスト/レスポンスの基本情報を構造化ログとして出力し、トレーサビリティを確保します。
    *   このファイルは定型的なコードであり、通常は変更不要です。

**2. `main.py` (難易度: ★★☆☆☆)**
*   **役割**: FastAPIアプリケーションの初期化と全体設定。
*   **機能**:
    *   `FastAPI`インスタンスを生成します。
    *   CORS（クロスオリジンリソース共有）ミドルウェアを設定します。
    *   `homebiyori_common`レイヤーから、共通エラーハンドリングやメンテナンスチェック用のミドルウェアを読み込みます。
    *   `/stripe` (Stripe Webhook) と `/health` (ヘルスチェック) のエンドポイントを持つルーターを登録します。
    *   アプリケーション全体の例外ハンドラを定義し、予期せぬエラー発生時に統一された形式でエラーレスポンスを返します。

**3. `handlers/stripe_handler.py` (難易度: ★★★☆☆)**
*   **役割**: Webhookリクエストの受付と検証。セキュリティの最前線です。
*   **機能**:
    *   `/api/webhook/stripe` というPOSTエンドポイントを定義します。
    *   リクエストヘッダーに含まれる`Stripe-Signature`を使い、**Webhook署名を検証**します。これにより、リクエストが本当にStripeから送信されたものであることを保証します。
    *   署名が無効な場合は、`400 Bad Request`エラーを返し、処理を中断します。
    *   署名が有効な場合、イベントの種類（`customer.subscription.*`など）を判別し、後続の`StripeWebhookService`に処理を委譲します。
    *   **重要**: Stripeへの応答として、内部処理の成否にかかわらず常に`200 OK`を返します。これにより、Stripeからの不要な再送を防ぎます。実際のエラーはCloudWatch Logsで監視・記録されます。

**4. `services/stripe_service.py` (難易度: ★★★★☆)**
*   **役割**: Webhookイベントのビジネスロジックを実装する中核部分。
*   **機能**:
    *   **サブスクリプション処理**:
        *   `created`: 新規サブスクリプション情報をDBに保存し、ユーザープロファイルのプランを更新します。
        *   `updated`: プラン変更やキャンセル予約などをDBに反映します。
        *   `deleted`: サブスクリプションが解約された際に、DBの状態を更新し、ユーザーをフリープランに戻します。
    *   **請求イベント処理**:
        *   `invoice.payment_succeeded`: 決済成功時に、その内容を`PaymentHistory`モデルに変換し、DBに保存します。
        *   `invoice.payment_failed`: 決済失敗の記録をDBに保存し、将来的なユーザー通知などの起点となります。

**5. `database.py` (難易度: ★★★☆☆)**
*   **役割**: DynamoDBとのすべての通信を管理するデータアクセス層。
*   **機能**:
    *   4つのテーブル（`core`, `chats`, `fruits`, `feedback`）を操作するためのクライアントを初期化します。
    *   サブスクリプション情報の取得（主キーまたはGSI経由）、作成、更新を行う非同期メソッドを提供します。
    *   `save_payment_history`メソッドで、決済履歴を`core`テーブルに書き込みます。
    *   サービスの稼働状態を確認するための`health_check`メソッドを実装しています。

**6. `models/` (難易度: ★★★☆☆)**
*   **役割**: Pydanticを利用して、サービス内で扱うデータの構造、型、バリデーションルールを定義します。
*   **`stripe_models.py`**:
    *   Stripeの`Subscription`や`Invoice`オブジェクトなど、Webhookで受信するデータ構造をモデル化します。
    *   これにより、複雑なJSONデータを安全かつ簡単に扱えるようになります。
*   **`payment_models.py`**:
    *   DBに保存する`PaymentHistory`のスキーマを定義します。
    *   `to_dynamodb_item`メソッドは、PydanticモデルをDynamoDBのSingle Table Designに合わせた形式（`PK`, `SK`など）に変換する重要なロジックを含みます。
    *   法的要件に基づき、**7年間のTTL（Time To Live）**を自動的に設定します。

**7. `core/config.py` (難易度: ★★☆☆☆)**
*   **役割**: 環境変数から設定値を読み込み、型安全な設定オブジェクトを提供します。
*   **機能**:
    *   `pydantic-settings`を使い、StripeのシークレットキーやDynamoDBのテーブル名などを環境変数から読み込みます。
    *   `@lru_cache`デコレータを使い、設定オブジェクトが一度だけ生成されるシングルトンパターンを実装しています。
    *   起動時に設定内容をログ出力する機能も持ちますが、シークレットキーなどの機密情報はログに残さないよう配慮されています。
