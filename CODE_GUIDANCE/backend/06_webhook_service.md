## Webhook Service 解説

### サービス概要

Webhook Serviceは、主にStripeからのWebhookイベントを受信し、処理するために特化されたマイクロサービスです。Stripe側で発生した様々なイベント（例: 決済成功、サブスクリプションの更新、支払い失敗など）をリアルタイムで受け取り、それに応じてアプリケーションのデータベースの状態を更新したり、関連する後続処理をトリガーしたりする役割を担います。

このサービスは、課金サービス（billing_service）と密接に連携しており、Stripeとアプリケーションのデータ整合性を保つ上で不可欠なコンポーネントです。

### 主要機能

1.  **Stripe Webhookイベントの受信と署名検証**: 
    Stripeから送信されるWebhookイベントを安全に受信します。受信したイベントは、Stripeが提供する署名検証メカニズムを用いて、リクエストが正当なStripeからのものであることを確認します。これにより、第三者によるなりすましや不正なリクエストを防ぎます。

2.  **サブスクリプション状態の同期**: 
    Stripe側でユーザーのサブスクリプション状態に変化があった場合（例: 新規登録、プラン変更、キャンセル、支払い失敗など）、そのイベントを受けてアプリケーションのデータベース（DynamoDB）に保存されているユーザーのサブスクリプション情報を最新の状態に同期します。

3.  **TTL更新キューへのメッセージ送信**: 
    DynamoDBのTTL (Time To Live) 機能を利用して、一定期間後に自動的にデータが削除されるように設定されているレコードのTTL値を更新するためのメッセージをキュー（例: SQS）に送信します。これにより、データの保持期間を適切に管理します。

4.  **DLQ (Dead-Letter Queue) によるエラーハンドリング**: 
    Webhookイベントの処理中にエラーが発生した場合、そのイベントをDLQに送信します。これにより、処理に失敗したイベントが失われることなく、後で再処理したり、エラーの原因を調査したりすることが可能になります。

5.  **課金履歴の提供**: 
    以前は`billing_service`が担当していた課金履歴の取得機能が、責任分離の原則に基づき`webhook_service`に移管されました。Stripeからのイベント（`invoice.payment_succeeded`など）を基に課金履歴を記録し、フロントエンドからのリクエストに応じて提供します。

### アーキテクチャ

*   **フレームワーク**: PythonのFastAPIを使用しており、高速なAPI開発と非同期処理に対応しています。
*   **デプロイ環境**: AWS Lambda上で動作するように、Mangumアダプターが利用されています。これにより、サーバーレス環境での効率的な運用が可能です。
*   **共通Lambda Layer**: `homebiyori_common`という共通のLambda Layerから、ロギング（`get_logger`）、統一されたエラーレスポンス（`error_response`）、メンテナンスチェックミドルウェア、認証関連のユーティリティなど、複数のサービスで共通して利用される機能がインポートされています。これにより、コードの再利用性と保守性が向上しています。
*   **ルーターによるエンドポイント管理**: FastAPIのルーター機能を利用して、`stripe_webhook_router`、`health_router`、`payment_history_router`といった機能ごとのエンドポイントが整理されています。

### Stripe Webhookとの連携

Webhook Serviceの最も重要な役割は、Stripe Webhookイベントを処理することです。Stripeは、決済やサブスクリプションに関する様々なライフサイクルイベントを、設定されたURL（このWebhook Serviceのエンドポイント）にHTTP POSTリクエストとして送信します。

*   **非同期処理とリアルタイム性**: Webhookは非同期でイベントを通知するため、アプリケーションはStripe側で何かが起こったことをほぼリアルタイムで知ることができます。これにより、ユーザーのサブスクリプション状態を常に最新に保つことが可能です。
*   **署名検証の重要性**: 受信したWebhookイベントのヘッダーに含まれる署名を検証することで、そのイベントが本当にStripeから送られたものであることを確認します。これは、悪意のある第三者による偽のイベント送信を防ぐための、極めて重要なセキュリティ対策です。
*   **イベントの種類に応じた処理**: Stripeは多種多様なイベントタイプを送信します（例: `checkout.session.completed`、`customer.subscription.updated`、`invoice.payment_succeeded`など）。Webhook Serviceは、これらのイベントタイプを識別し、それぞれに応じたビジネスロジック（例: ユーザーのプランをアクティブにする、課金履歴を記録する、メールを送信するなど）を実行します。

Webhook Serviceは、Stripeとアプリケーションの間の「橋渡し役」として、課金システムの信頼性と正確性を支える基盤となっています。