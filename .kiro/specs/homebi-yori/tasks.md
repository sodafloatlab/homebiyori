# 実装計画（統合チャット機能版）

## フェーズ1: ローカルデモアプリ確認・改良（完了済み）

- [x] 0. つぶやきの木陰デモアプリ基盤構築
  - AIチャット機能の基本実装完了
  - 木の成長UIとチャット統合実装完了
  - 水彩画風UIデザイン適用完了

## フェーズ2: インフラストラクチャ構築（統合Lambda構成）

- [x] 1. AWS基盤構築（統合Lambda版）
  - Terraformによる2つのLambda構成実装完了
  - コスト最適化された統合設計適用完了
  - _要件: 全体基盤_

- [x] 1.1 Terraform環境構築（更新完了）
  - 3層アーキテクチャ（datastore → backend → frontend）の構築
  - Core Service + AI Service の2つのLambda構成
  - DynamoDB、S3、API Gateway、Cognito、Bedrockの統合設定

- [ ] 1.2 認証基盤構築（API Gateway + Cognito）
  - Amazon Cognitoユーザープール設定
  - API Gateway Cognito Authorizerの設定
  - Google OAuth連携設定
  - 統合Lambda構成での認証フロー構築

- [ ] 1.3 共通Lambda Layer構築
  - shared/配下の共通ライブラリ実装
  - DynamoDB、S3操作の共通化
  - JWT解析ヘルパーの実装
  - 共通バリデーション・ログ設定

## フェーズ3: 統合バックエンド実装（2つのLambda構成）

- [ ] 2. Core Service Lambda実装
  - ユーザー管理、チャット、木の成長、設定を統合
  - _要件: 要件1（統合チャット機能）、要件2（努力の可視化機能）、要件3（設定変更機能）_

- [ ] 2.1 統合チャット機能API実装
  - `POST /core/chat/start` - チャットセッション開始（AIロール・気分設定）
  - `POST /core/chat/send` - メッセージ送信（テキスト・感情アイコン）
  - `PUT /core/chat/mood` - チャット途中での気分変更
  - `POST /core/chat/end` - チャットセッション終了（AIロール変更時）
  - `GET /core/chat/history` - チャット履歴取得

- [ ] 2.2 木の成長管理API実装
  - `GET /core/tree/status` - 木の現在状態取得
  - `POST /core/tree/grow` - 文字数ベース成長処理
  - `GET /core/tree/fruits` - 実の一覧取得
  - `POST /core/tree/fruits/{fruit_id}/praise` - 実タップ時の褒めメッセージ取得

- [ ] 2.3 ユーザー管理API実装
  - `GET /core/users/profile` - プロフィール取得
  - `PUT /core/users/profile` - プロフィール更新
  - `POST /core/users/children` - 子供情報登録
  - `GET /core/users/children` - 子供情報取得

- [ ] 2.4 設定管理API実装
  - `PUT /core/settings/ai-role` - AIロール変更
  - `PUT /core/settings/praise-level` - 褒めレベル変更
  - `DELETE /core/settings/account` - アカウント削除

- [ ] 2.5 チャットコンテンツS3保存戦略実装
  - チャット内容のS3保存
  - DynamoDBにはメタデータのみ保存
  - コスト最適化されたストレージ設計

- [ ] 3. AI Service Lambda実装
  - AI処理、感情検出、Bedrock連携を専門化
  - _要件: 要件1（統合チャット機能）、感情検出機能_

- [ ] 3.1 Amazon Bedrock連携実装
  - Claude 3 Haiku APIクライアント実装
  - 効率的なプロンプト設計（約700トークン入力、150トークン出力）
  - コスト最適化されたAPI呼び出し

- [ ] 3.2 感情検出機能実装（新規）
  - 感情分析専用プロンプト実装
  - 感情強度・内容深度・育児関連度の評価
  - 1日1回制限による実生成制御
  - フォールバック機能実装

- [ ] 3.3 AIロール別プロンプト実装（更新されたテーマカラー）
  - たまさん（下町のベテランおばちゃん）: 感情受容力重視・ピンクテーマ
  - まどか姉さん（バリキャリ共働きママ）: 論理的共感・青テーマ
  - ヒデじい（元教師のやさしい詩人）: 静かな言葉・オレンジテーマ

- [ ] 3.4 今日の気分による制御実装
  - 褒めてほしい気分：人間としての努力への褒め拡張
  - 話を聞いてほしい気分：共感重視・感情アイコン対応
  - AI回答制御原則：助言禁止・比較禁止・領域フィルター

- [ ] 3.5 AI機能API実装
  - `POST /ai/chat` - チャット応答生成
  - `POST /ai/emotion/analyze` - 感情分析
  - `POST /ai/tree/fruits` - 実の生成処理

## フェーズ4: 統合フロントエンド実装

- [ ] 4. 統合チャット体験フロントエンド実装
  - チャットページでの木の成長統合表示
  - _要件: 要件1（統合チャット機能）_

- [ ] 4.1 トップページ実装
  - AIロール選択インターフェース
  - 今日の気分選択（褒めて・聞いて）
  - 統合チャット体験への導線

- [ ] 4.2 統合チャットページ実装
  - チャット + 木の成長背景表示
  - リアルタイム木の成長アニメーション
  - 感情アイコン送信機能
  - 気分切り替え機能（途中変更可能）

- [ ] 4.3 チャット時のUI要件実装
  - 背景に木をうっすら表示
  - チャット中の穏やかな木の成長更新
  - AIによる成長補足メッセージ
  - チャット上部のAIロール・気分表示

- [ ] 5. 努力の可視化機能フロントエンド実装
  - 文字数・感情表現による木の成長UI
  - _要件: 要件2（努力の可視化機能）_

- [ ] 5.1 木の成長段階実装（チャット連動）
  - 文字数に応じた木の成長表示
  - 登録済みユーザーの累積成長
  - 未登録ユーザーの新芽からスタート

- [ ] 5.2 AIロール別実の実装（更新されたテーマカラー）
  - たまさん：ピンクの光る実
  - まどか姉さん：青の光る実
  - ヒデじい：オレンジの光る実
  - 感情込められた内容でのみ実追加

- [ ] 5.3 実のインタラクション実装
  - 実タップ時の褒めメッセージ表示
  - 実ができた時の内容は保存しない設計
  - 時間帯・季節による背景演出変更

- [ ] 6. 認証連携フロントエンド実装
  - API Gateway + Cognito認証の統合
  - _要件: 要件4（ユーザー認証・管理機能）_

- [ ] 6.1 AWS Amplify Auth統合
  - Google OAuth認証フロー実装
  - JWT トークン管理
  - 認証状態の管理

- [ ] 6.2 認証済み状態での機能連携
  - 統合APIエンドポイントとの認証連携
  - 過去のチャット履歴・子供情報把握
  - セキュアなAPI通信

- [ ] 7. 設定管理フロントエンド実装
  - プロフィール・設定管理UI構築
  - _要件: 要件3（設定変更機能）_

- [ ] 7.1 褒めのレベル設定実装
  - ライト：「一言だけ欲しい」
  - スタンダード：「ちょっと励ましてほしい」（デフォルト）
  - ディープ：「ちゃんと向き合って褒めてほしい」

- [ ] 7.2 AIロール変更機能実装
  - 3つのキャラクター選択UI
  - チャット終了後の変更制限
  - リアルタイムプレビュー機能

- [ ] 7.3 アカウント情報管理実装
  - ニックネーム変更
  - 子供情報管理（愛称OK）
  - アカウント削除機能

## フェーズ5: Design System & コンポーネント最適化

- [ ] 8. フロントエンドコンポーネント構造改善
  - Design System化による再利用性向上
  - _改善されたコンポーネント構成の適用_

- [ ] 8.1 Primitives層実装
  - Button、Input、Select、Modal、Card
  - 基本UIコンポーネントの統一

- [ ] 8.2 Composite層実装
  - AiCharacterCard、EmotionPanel、MessageBubble
  - ProgressIndicator、複合コンポーネント

- [ ] 8.3 Features層実装
  - ai-interaction、chat、tree、profile、auth
  - 機能別コンポーネントの統合

- [ ] 8.4 統一的なAPI抽象化実装
  - lib/api配下でAPI処理とフックを統合管理
  - useChat、useTree、useAuth、useProfileフック

## フェーズ6: 運用・監視・最適化

- [ ] 9. メンテナンス機能実装
  - AWS WAFによるインフラレベル制御
  - _要件: 要件5（メンテナンス機能）_

- [ ] 9.1 WAFメンテナンスモード実装
  - AWS WAFによるメンテナンス制御
  - アプリケーションレイヤー外での制御
  - メンテナンス画面の実装

- [ ] 10. 監視・ログ設定
  - New Relic監視システム構築
  - _要件: 運用全般_

- [ ] 10.1 統合Lambda監視実装
  - Core Service監視
  - AI Service監視
  - パフォーマンス・エラー率監視

- [ ] 10.2 感情検出精度監視実装
  - 実生成率監視（目標：15%程度）
  - A/Bテスト対応
  - 閾値パラメータ調整機能

- [ ] 11. パフォーマンス最適化
  - 統合構成でのパフォーマンス向上
  - _要件: 要件6（コスト最適化機能）_

- [ ] 11.1 統合Lambda最適化実装
  - Core Service：メモリ512MB、タイムアウト30秒
  - AI Service：メモリ1024MB、タイムアウト60秒
  - 並列処理による応答時間短縮

- [ ] 11.2 フロントエンド最適化実装
  - Next.js Dynamic Import
  - 木の成長アニメーション効率化
  - チャット表示の仮想化

- [ ] 12. CI/CD・デプロイ自動化
  - 統合Lambda構成での自動デプロイ
  - _要件: 運用全般_

- [ ] 12.1 GitHub Actions設定（統合版）
  - Core Service + AI Serviceの同時デプロイ
  - 統合テスト・ビルド自動化
  - セキュリティスキャン統合

## コスト目標とマイルストーン（統合版）

**想定コスト**：月間100ユーザーで約$10.14（統合により13%削減達成）

**統合による削減効果**：
- Lambda実行コスト：約40%削減
- API Gateway呼び出し：約30%削減
- 運用複雑性：約50%削減

**主要マイルストーン**：
- フェーズ1完了：デモアプリ完成（完了済み）
- フェーズ2完了：統合インフラ基盤完成
- フェーズ3完了：統合バックエンドAPI完成
- フェーズ4完了：統合チャット体験完成
- フェーズ5完了：Design System化完成
- フェーズ6完了：本番運用開始

**技術特記事項**：
- **統合Lambda構成**：Core Service + AI Service の2つのみ
- **統合チャット機能**：投稿機能を廃止し、チャット中心の体験設計
- **感情検出機能**：Amazon Bedrock Claude 3 Haikuによる高精度感情分析
- **コスト最適化**：チャット内容S3保存、統合Lambda、効率的プロンプト設計
- **Design System**：primitives → composite → features の3層構成

**実装優先度**：
- **高優先度（Phase 1）**：統合チャット機能、努力の可視化機能、設定変更機能
- **中優先度（Phase 2）**：ユーザー認証・管理機能、メンテナンス機能
- **低優先度（Future）**：写真判定機能（チャット優先のため後回し）