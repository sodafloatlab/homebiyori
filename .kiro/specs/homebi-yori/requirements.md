# 要件定義書

## はじめに

「ほめびより」は、育児中の親をAIが優しく褒めてくれるWebアプリケーションです。子どもの笑顔の写真や日常の出来事を投稿すると、AIがその内容を分析して親をポジティブにフィードバックします。主役は子供ではなく親であり、押し付けない優しさをテーマとして、育児のやる気や自己肯定感を高めることを目的としています。

## 機能要件（カテゴリー別）

## 1. チャット機能

### 1.1 統合チャット機能

**ユーザーストーリー:** 育児中の親として、AIロールと今日の気分を選択し、統合的なチャット体験を通じて支援を受けたい

#### 受入基準
1. WHEN ユーザーがチャット開始 THEN システムはAIロール選択と今日の気分選択画面を表示する
2. WHEN ユーザーがAIロールを選択 THEN システムは選択されたロールの特性に応じたチャット体験を提供する
3. WHEN ユーザーが今日の気分を選択 THEN システムは「褒めてほしい気分」または「話を聞いてほしい気分」に応じてAIの返答を制御する
4. WHEN ユーザーがチャットで会話 THEN システムは会話内容に応じて努力の可視化機能の木のUIを成長させる
5. WHEN AIが回答を生成 THEN システムは「AIの回答は必ずしも正しくない場合があります」という注意書きを明示する
6. WHEN ユーザーが登録済み THEN システムは過去の投稿内容や子供の情報を把握した状態でチャットを行う

### 1.2 AIキャラクターシステム

#### AIロール詳細
- **たまさん（下町のベテランおばちゃん）**
  - テーマカラー：ピンク
  - 感情の受容力が圧倒的、初産・不安定なユーザーの心を溶かす力
  - 人情味と「大丈夫って言ってほしい人」に最適

- **まどか姉さん（バリキャリ共働きママ）**
  - テーマカラー：青
  - 論理的な共感＋自己効力感を高める褒め方
  - 忙しい人、自己評価が低いがんばり屋に響く
  - 「実感のある褒め」のロールモデルとして有効

- **ヒデじい（元教師のやさしい詩人）**
  - テーマカラー：オレンジ
  - 夜に効く、静かな言葉の薬
  - 「行動」ではなく「姿勢」や「人生」に光を当てる
  - 孤独感を和らげ、振り返る時間に寄り添う

### 1.3 感情認識・対応システム

#### 今日の気分による制御
**褒めてほしい気分の場合:**
- 常に育児だけでなく「人間としての努力」にも褒めを広げる
- 「寝かしつけおつかれさま」だけでなく、「自分を責めずに一息つけたあなた、ちゃんとえらい」のような表現

**話を聞いてほしい気分の場合:**
- 現実の人間にはこぼしにくい内容でもAIならいつでも話を聞く発散場所として提供
- 共感を第一にユーザーに寄り添うことを最優先
- 「無言でもいい相談」設計：感情アイコンだけでも対応（😔→「その顔…今日はたいへんだったね」）
- 感情の名付けができない人でも受け入れられる設計

#### 感情アイコン機能
**実装済み感情アイコン:**
- 😊 嬉しい
- 😔 悲しい
- 😤 怒り
- 😰 不安
- 😴 疲れた
- 😅 困った

### 1.4 AI回答制御システム

#### AI回答制御原則
- **助言禁止原則**: 教育、人生判断などの専門的アドバイスを一切行わず、共感にとどめる
- **比較禁止原則**: 他者との比較・過去のユーザー行動との評価を避ける
- **領域フィルター**: 以下の分野は制限
  - 医療相談: 「ごめんね、わたしにはそれをちゃんと考える力がまだなくて…」
  - DV・虐待に関する疑い: 緊急連絡先を提示する導線へ
  - 離婚・死別などの深刻な人生相談: 「重たい気持ちだね…。それだけ大事なことなんだね」位に留める

### 1.5 チャットUI機能

#### チャットヘッダー機能
1. WHEN 1:1チャット THEN システムは選択したAIキャラクターのアバター、名前、モード表示をヘッダーに表示する
2. WHEN グループチャット THEN システムは参加中のAIキャラクターのアバターを重ねて表示し、参加人数を表示する
3. WHEN ユーザーが気分を変更したい THEN システムはヘッダーに「ほめほめ」「聞いて」のトグルボタンを提供する
4. WHEN プレミアムユーザー THEN システムはヘッダーに「ディープ」「ノーマル」のpraise_levelモードトグルボタンを提供する
5. WHEN ディープモードが有効 THEN システムはモード表示に「ディープ」バッジを追加表示する
6. WHEN ユーザーが対話モードを変更したい THEN システムはチャットUIでInteractionMode（praise/listen）の選択機能を提供する

#### チャットメッセージ機能
1. WHEN ユーザーがメッセージを送信 THEN システムはメッセージをチャットエリアに表示し、文字数をカウントする
2. WHEN AIが返答 THEN システムはAIキャラクターのアイコンと名前を付けて返答を表示する
3. WHEN グループチャットのAI返答 THEN システムは各AIキャラクターのテーマカラーでメッセージを色分けして表示する
4. WHEN ユーザーが感情アイコンをタップ THEN システムはその感情をメッセージとして送信し、AIが感情に応じた返答をする
5. WHEN メッセージ表示 THEN システムはメッセージにタイムスタンプを付けて表示する

#### 木の成長状態表示機能
1. WHEN ユーザーがチャット中 THEN システムはチャット画面の上部に木の成長状態をコンパクトに表示する
2. WHEN 木の成長状態が表示される THEN システムは現在の成長段階、次の段階までの文字数、進捗バーを表示する
3. WHEN ユーザーが成長状態をタップ THEN システムは木の詳細表示画面に遷移する

### 1.6 InteractionMode（対話モード）機能

**ユーザーストーリー:** 育児中の親として、今日の気分に応じた対話トーンを選択し、最適なAI応答を受けたい

#### 受入基準
1. WHEN ユーザーがチャットUIでInteractionModeを選択 THEN システムは以下の2つのモードを提供する
   - **praise**: 積極的な肯定・承認・励まし中心
   - **listen**: 共感・理解・寄り添い中心

2. WHEN ユーザーがInteractionModeをpraiseに設定 THEN システムは褒めて欲しい気分に最適化された肯定的な応答を生成する

3. WHEN ユーザーがInteractionModeをlistenに設定 THEN システムは話を聞いて欲しい気分に最適化された共感的な応答を生成する

4. WHEN AIが応答を生成 THEN システムはpraise_levelとInteractionModeの両方を考慮した最適な応答を提供する

5. WHEN ユーザーがInteractionModeを変更 THEN システムは変更内容をDynamoDBユーザープロフィールに永続化する

#### 利用シーン
- **praise**: 自己肯定感を高めたい時、頑張りを認めて欲しい時、励ましが欲しい時
- **listen**: 話を聞いて欲しい時、共感して欲しい時、寄り添って欲しい時

### 1.7 グループチャット機能（プレミアム限定）

#### 受入基準
1. WHEN プレミアムユーザーがグループチャット選択 THEN システムは複数AIキャラクターとの同時チャット機能を提供する
2. WHEN グループチャット中 THEN システムは各AIキャラクターの発言を色分けして表示する
3. WHEN グループチャット中 THEN システムは各AIの特性を活かした異なる視点からの支援を提供する

## 2. 努力の可視化機能

### 2.1 木の成長システム

**ユーザーストーリー:** 育児中の親として、チャットでの文字数と感情表現に応じて成長する木のUIを通じて、自分の努力を視覚的に確認したい

#### 受入基準
1. WHEN ユーザーがチャットで文字を入力 THEN システムは文字数に応じて木のUIを成長させる
2. WHEN ユーザーが未登録 THEN システムは常に新芽からスタートする
3. WHEN ユーザーが登録済み THEN システムは文字数を累積させていく
4. WHEN AIが会話から感情を感じ取る THEN システムはAIロールのテーマカラーの光る実を一日一つまで追加する
5. WHEN ユーザーが適当な一言だけつぶやく THEN システムは実を追加しない（感情が込められた内容の場合のみ実を追加）
6. WHEN ユーザーが実をタップ THEN システムはAIが頑張りを褒めてくれる（実ができた時の内容は保存しない）

### 2.2 ほめの実インタラクション機能

**ユーザーストーリー:** 育児中の親として、木に実った「ほめの実」をタップしてAIからの褒め言葉をもらいたい

#### 受入基準
1. WHEN 木に実が表示される THEN システムは実をタップ可能なインタラクティブ要素として表示する
2. WHEN ユーザーが実をタップ THEN システムは選択した実の情報をモーダルで表示する
3. WHEN 実のモーダルが表示される THEN システムは実の色（AIキャラクターのテーマカラー）、日付、関連するAIキャラクター、会話時のユーザー文言とAI回答を表示する
4. WHEN 実が追加される THEN システムはAIロールのテーマカラーの光る実を一日一つまで追加する
5. WHEN ユーザーが数回のメッセージ交換を行う THEN システムは感情が込められた内容と判断した場合のみ実を追加する（適当な一言では追加しない）

## 3. UI/UX機能

### 3.1 ランディングページシステム

**ユーザーストーリー:** 育児中の親として、初回訪問時にアプリの価値と機能を分かりやすく理解し、すぐに利用を開始したい

#### 受入基準
1. WHEN ユーザーがアプリに初回アクセス THEN システムはアプリの概要と主要機能を魅力的に紹介する
2. WHEN ユーザーがサービス概要を確認 THEN システムは「優しく褒めてくれるAI」「木の成長による可視化」「個人情報保護」の特徴を明示する
3. WHEN ユーザーが利用開始を希望 THEN システムは「チャットを始める」「ログイン」「プレミアムプラン」等の明確なCTAボタンを提供する
4. WHEN ユーザーがフッターを確認 THEN システムは法的文書、サポート情報、運営会社情報へのリンクを提供する

### 3.2 キャラクター選択システム

**ユーザーストーリー:** 育児中の親として、直感的な3段階プロセスで今日の気分とAIキャラクターを選択したい

#### 受入基準
1. WHEN ユーザーがキャラクター選択開始 THEN システムはステッププログレスインジケーターを表示する
2. WHEN ステップ1（気分選択） THEN システムは「褒めてほしい」「聞いてほしい」の2オプションを表示する
3. WHEN ステップ2（キャラクター選択） THEN システムは3人のAIキャラクターを表示し、選択した気分に合うキャラクターに「おすすめ」バッジを表示する
4. WHEN ステップ3（確認） THEN システムは選択内容を確認し、チャット開始ボタンを表示する
5. WHEN ユーザーがプレミアムユーザー THEN システムは確認画面でプレミアム機能の案内を表示する

### 3.3 ナビゲーションシステム

**ユーザーストーリー:** 育児中の親として、アプリ内をスムーズに移動できるナビゲーションを利用したい

#### 受入基準
1. WHEN ユーザーがアプリ内を移動 THEN システムは各ページに適切なナビゲーションヘッダーを表示する
2. WHEN ユーザーが深いページにいる THEN システムはパンくずナビゲーションを表示する
3. WHEN ユーザーが戻るボタンをタップ THEN システムは適切な前のページに戻る
4. WHEN ユーザーがホームボタンをタップ THEN システムはランディングページに移動する
5. WHEN ログインユーザー THEN システムはナビゲーションヘッダーにユーザーメニューを表示する

### 3.4 レスポンシブデザイン機能

**ユーザーストーリー:** 育児中の親として、スマートフォン、タブレット、PCなど異なるデバイスで快適にアプリを利用したい

#### 受入基準
1. WHEN ユーザーがモバイルデバイスでアクセス THEN システムはモバイルファーストデザインで表示する
2. WHEN ユーザーがタブレットでアクセス THEN システムはタブレットに最適化されたレイアウトで表示する
3. WHEN ユーザーがPCでアクセス THEN システムはデスクトップレイアウトで表示する
4. WHEN ユーザーがタッチインタラクション THEN システムはタッチターゲットを適切なサイズで提供する

### 3.5 フィードバックシステム

**ユーザーストーリー:** 育児中の親として、アプリの状態や処理結果を適切なフィードバックで確認したい

#### 受入基準
1. WHEN ユーザーがローディング状態 THEN システムはローディングスピナーと適切なメッセージを表示する
2. WHEN ユーザーの操作が成功 THEN システムはトースト通知で成功を知らせる
3. WHEN ユーザーの操作が失敗 THEN システムはエラートーストで問題を知らせる
4. WHEN トースト表示 THEN システムは一定時間後に自動で非表示にする

## 4. アカウント管理機能

### 4.1 ユーザー認証システム

**ユーザーストーリー:** 育児中の親として、安全かつ簡単にアプリを利用し、自分のデータを管理したい

#### 受入基準
1. WHEN ユーザーがアプリにアクセス THEN システムはAmazon Cognitoを使用したGoogleアカウント連携認証機能を提供する
2. WHEN ユーザーがログイン画面にアクセス THEN システムは「Googleでログイン」ボタンを表示してワンクリック認証を可能にする
3. WHEN ユーザーがアカウント作成 THEN システムはニックネームのみ設定可能とし、個人情報の収集は最小限に留める
4. WHEN ユーザーがログイン THEN システムは個人のチャット履歴と努力の可視化データを表示する
5. IF ユーザーがデータ削除を要求 THEN システムは個人データを完全に削除する機能を提供する

### 4.2 設定変更機能

**ユーザーストーリー:** 育児中の親として、褒めのレベルやAIロール、アカウント情報を自分の状況に合わせて変更したい

#### 受入基準
1. WHEN ユーザーが設定画面にアクセス THEN システムは褒めのレベル設定機能を提供する
2. WHEN ユーザーが褒めのレベルを選択 THEN システムは以下のオプションを提供する：
   - ノーマル：「標準的な褒め方」（デフォルト）
   - ディープ：「深く寄り添った褒め方」（プレミアム限定）
3. WHEN ユーザーがAIロール変更を選択 THEN システムはAIロールを途中で変更できる機能を提供する
4. WHEN ユーザーがアカウント情報変更を選択 THEN システムはニックネームの変更、アカウント削除機能を提供する

### 4.3 アカウント削除機能

**ユーザーストーリー:** ユーザーとして、必要に応じて自分のアカウントとデータを安全かつ確実に削除したい

#### UX設計原則
- **透明性確保**: ユーザーが十分な情報に基づいて決定できる
- **選択の自由**: サブスクリプションとアカウント削除を分離して選択可能
- **段階的プロセス**: 誤操作防止のための段階的確認
- **心理的配慮**: 進捗表示で手続きの負担を軽減

#### 受入基準

**第1段階：サブスクリプション状態確認と選択**
1. WHEN ユーザーが設定画面から「アカウント削除」を選択 THEN システムはアカウント削除フローを開始し、進捗インジケーター（1/3）を表示する
2. WHEN アカウント削除フロー開始 THEN システムはまず現在のサブスクリプション状態を表示する
3. WHEN アクティブなサブスクリプションがある THEN システムは以下の選択肢を提供する：
   - 「サブスクリプションをキャンセルしてアカウントを削除」
   - 「サブスクリプションのみキャンセル（アカウントは残す）」
   - 「アカウントのみ削除（サブスクリプションは別途解約が必要）」
4. WHEN サブスクリプションが無い THEN システムはアカウント削除選択肢のみ表示する
5. WHEN ユーザーが選択肢を選ぶ THEN システムは次の段階に進む

**第2段階：削除内容の詳細説明**
6. WHEN 第2段階表示 THEN システムは進捗インジケーター（2/3）を表示し、削除されるデータの詳細を説明する：
   - チャット履歴
   - 木の成長データ
   - ユーザープロフィール
   - AI設定情報
7. WHEN データ削除説明表示 THEN システムは「この操作は元に戻せません」ことを明確に警告する
8. WHEN 削除データ一覧表示 THEN システムは削除されるデータの詳細一覧を表示する

**第3段階：最終確認と実行**
9. WHEN 第3段階表示 THEN システムは進捗インジケーター（3/3）を表示し、最終確認を求める
10. WHEN 最終確認画面表示 THEN システムはユーザーに「削除」と入力することを求めて誤操作を防ぐ
11. WHEN ユーザーが削除を実行 THEN システムは以下の処理を順次実行する：
    - サブスクリプション解約（選択された場合）
    - DynamoDBからのユーザーデータ完全削除
    - Amazon Cognitoからのユーザーアカウント削除
12. WHEN 削除処理完了 THEN システムは削除完了画面を表示し、自動的にログアウト処理を実行する

**エラーハンドリング**
13. WHEN サブスクリプション解約でエラー THEN システムはエラー内容を表示し、手動解約の案内を提供する
14. WHEN データ削除でエラー THEN システムはサポートへの連絡方法を案内する
15. WHEN 削除処理中にタイムアウト THEN システムは処理状況の確認方法を案内する

**法的・コンプライアンス要件**
16. WHEN 削除処理実行 THEN システムは30日以内にバックアップからもデータを完全削除する
17. WHEN 法的要請でデータ保持が必要 THEN システムは最低限の情報のみを法定期間保持し、ユーザーに通知する

### 4.4 プレミアムプラン管理

#### 受入基準
1. WHEN ユーザーがプレミアムプラン画面にアクセス THEN システムはプレミアム機能の詳細と価格を表示する
2. WHEN ユーザーがプレミアムプラン加入 THEN システムは以下の機能を提供する：
   - グループチャット機能
   - ディープモード（深い褒め方）
   - チャット履歴180日保存（通常30日）
3. WHEN ユーザーがプレミアムプラン解約 THEN システムは解約理由の収集と段階的な解約プロセスを提供する

## 5. プレミアム機能

### 5.1 プレミアムランディングページ

**ユーザーストーリー:** 育児中の親として、プレミアムプランの機能と価格を理解し、加入を検討したい

#### 受入基準
1. WHEN ユーザーがプレミアムページにアクセス THEN システムはプレミアム機能の特徴を魅力的に表示する
2. WHEN ユーザーが機能比較を確認 THEN システムは無料プランとプレミアムプランの機能比較表を表示する
3. WHEN ユーザーが料金情報を確認 THEN システムは月額料金と支払い方法を明示する
4. WHEN ユーザーが加入ボタンをタップ THEN システムは決済手続きへ遷移する

### 5.2 プレミアムプラン解約システム

**ユーザーストーリー:** プレミアムユーザーとして、必要に応じてプランを解約したい

#### 受入基準
1. WHEN ユーザーが解約手続き開始 THEN システムは解約理由選択画面を表示する
2. WHEN ユーザーが理由を選択 THEN システムは任意のフィードバック入力欄を提供する
3. WHEN ユーザーが解約確認 THEN システムは利用できなくなる機能と継続利用可能な機能を明示する
4. WHEN ユーザーが最終解約確定 THEN システムは解約完了画面と今後の案内を表示する

## 6. システム運用機能

### 6.1 メンテナンス機能

**ユーザーストーリー:** サービス管理者として、運用上必要な場合にアプリをメンテナンスモードに切り替えたい

#### 受入基準
1. WHEN システムメンテナンスが必要 THEN 管理者はAWS WAFを使用してアプリケーションレイヤーではなくインフラレベルでメンテナンスページを表示できる
2. WHEN メンテナンスモードが有効 THEN システムは全ユーザーに対してメンテナンス中であることを通知し、適切な復旧予定時間を表示する
3. WHEN メンテナンスが完了 THEN 管理者は迅速にメンテナンスモードを解除してサービスを復旧できる

### 6.2 コスト最適化機能

**ユーザーストーリー:** サービス提供者として、スモールスタートでコストを最小限に抑えながらサービスを運営したい

#### 受入基準
1. WHEN システムがDynamoDBを使用 THEN システムはオンデマンド課金モードで運用する
2. WHEN システムがLambdaを使用 THEN システムは最小限のメモリサイズで運用する（ECS Fargateは使用しない）
3. WHEN システムがAWS Bedrockを使用 THEN システムは効率的なプロンプト設計でAPI呼び出し回数を最適化する
4. WHEN システムがS3を使用 THEN システムは適切なライフサイクルポリシーでストレージコストを最適化する
5. WHEN ユーザーがGoogle認証を利用 THEN システムはユーザーフレンドリーな認証体験を提供してコスト効率を高める

## 7. 法的コンプライアンス機能

### 7.1 法的文書表示機能

**ユーザーストーリー:** サービス利用者として、利用規約やプライバシーポリシーなどの法的文書を確認したい

#### 受入基準
1. WHEN ユーザーが利用規約画面にアクセス THEN システムは最新の利用規約を表示する
2. WHEN ユーザーがプライバシーポリシー画面にアクセス THEN システムは個人情報の取扱いについて詳細を表示する
3. WHEN ユーザーが特定商取引法表記画面にアクセス THEN システムは事業者情報と販売条件を表示する

### 7.2 サポート機能

**ユーザーストーリー:** サービス利用者として、疑問や問題があった時に適切なサポートを受けたい

#### 受入基準
1. WHEN ユーザーがFAQ画面にアクセス THEN システムはよくある質問と回答をカテゴリー別に整理して表示する
2. WHEN ユーザーがお問い合わせ画面にアクセス THEN システムは問い合わせフォームを提供する
3. WHEN ユーザーがお問い合わせ送信 THEN システムは送信完了を通知し、適切な期間内に回答することを告知する
4. WHEN FAQが表示される THEN システムはユーザーが簡単に目的の情報を見つけられるようにアコーディオン形式で表示する

## 実装優先度

### 高優先度（Phase 1）
1. チャット機能（統合チャット、AIキャラクター、感情認識・対応、AI回答制御、チャットUI機能）
2. 努力の可視化機能（木の成長、ほめの実インタラクション）

3. UI/UX機能（ランディングページ、キャラクター選択、ナビゲーション、レスポンシブデザイン、フィードバック）

### 中優先度（Phase 2）
4. アカウント管理機能（ユーザー認証、設定変更、アカウント削除、プレミアムプラン管理）
5. プレミアム機能（プレミアムランディングページ、解約システム）

### 低優先度（Phase 3）
6. システム運用機能（メンテナンス、コスト最適化）
7. 法的コンプライアンス機能（法的文書表示、サポート機能）

## 8. 運用・監視機能

### 8.1 Parameter Store管理システム

**ユーザーストーリー:** サービス管理者として、システム設定とメンテナンス制御をParameter Storeで動的に管理したい

#### 受入基準
1. WHEN システム設定変更が必要 THEN 管理者はAWS Systems Manager Parameter Storeを使用して以下のパラメータを動的に変更できる：
   - メンテナンスモード制御 (`/prod/homebiyori/maintenance/enabled`)
   - AI設定の動的調整 (`/prod/homebiyori/ai/model_config`)
   - 機能フラグ制御 (`/prod/homebiyori/features/flags`)
   - セキュリティ設定 (`/prod/homebiyori/security/rate_limits`)
   - 木の成長閾値 (`/prod/homebiyori/tree/growth_thresholds`)

2. WHEN セキュリティ関連パラメータ THEN システムはSecureString型でKMS暗号化を使用する：
   - Stripe APIキー (`/prod/homebiyori/stripe/api_key`)
   - 内部API認証キー (`/prod/homebiyori/internal/api_key`)
   - Webhook署名シークレット (`/prod/homebiyori/stripe/webhook_secret`)

3. WHEN 運用時パラメータ変更 THEN TerraformでのParameter Store管理はignore_changes設定により運用変更を保護する

4. WHEN 全Lambda関数 THEN システムは統一的なParameter Store取得関数を提供し、環境変数経由でパラメータ参照を可能にする

### 8.2 システム監視機能

**ユーザーストーリー:** サービス管理者として、アプリケーションの健全性とパフォーマンスを継続的に監視したい

#### 受入基準
1. WHEN システム監視 THEN 管理者は以下のメトリクスをCloudWatchで監視できる：
   - API レスポンス時間（目標値：5秒以下）
   - Amazon Bedrock API使用量とエラー率（目標値：エラー率1%以下）
   - Lambda実行時間とエラー率（目標値：エラー率5%以下）
   - DynamoDB読み書きパフォーマンス
   - ユーザーアクティビティ統計

2. WHEN 異常検知 THEN システムは以下の条件でアラートを発信する：
   - API エラー率が5%を超過
   - レスポンス時間が5秒を超過
   - Bedrock APIエラー率が1%を超過
   - Lambda同時実行数が制限に接近

3. WHEN ログ管理 THEN システムは全サービスで統一的な構造化ログ形式（JSON）を使用し、以下の情報を記録する：
   - ユーザーID、リクエストID、実行時間
   - エラー詳細、スタックトレース
   - ビジネスメトリクス（チャット送信、木の成長等）

### 8.3 コスト最適化管理機能

**ユーザーストーリー:** サービス提供者として、運用コストを監視・最適化し、収益性を保持したい

#### 受入基準
1. WHEN コスト監視 THEN システムは月間100アクティブユーザー時の想定コスト構成を維持する：
   - Amazon Bedrock（Claude 3 Haiku）: $1.20/月
   - DynamoDB オンデマンド: $2.70/月
   - Lambda実行コスト: $0.65/月
   - S3ストレージ: $0.25/月
   - CloudFront CDN: $8.50/月
   - 総運用コスト: $16.40/月（目標値）

2. WHEN リソース最適化 THEN システムは以下の最適化施策を実装する：
   - Lambda分割による効率的なメモリ・CPU使用
   - S3 Intelligent Tieringによるストレージコスト削減
   - DynamoDB TTL自動削除による不要データ排除
   - 効率的なプロンプト設計によるBedrock API使用量削減

3. WHEN ライフサイクル管理 THEN システムは以下のデータライフサイクルポリシーを適用する：
   - チャット履歴: TTL管理（無料30日/プレミアム180日）
   - 通知データ: 90日後自動削除
   - ログデータ: 30日後Glacier移行、7年後完全削除

## 9. アプリ内通知システム

### 9.1 通知管理機能

**ユーザーストーリー:** ユーザーとして、重要なアカウント変更やサブスクリプション状態をメール代替のアプリ内通知で確認したい

#### 受入基準
1. WHEN 重要な状態変更 THEN システムは以下の通知をアプリ内通知として作成する：
   - サブスクリプション解約完了・再開
   - 決済成功・失敗
   - プラン変更（月額⇔年額）
   - アカウント削除完了
   - メンテナンス開始・終了

2. WHEN 通知表示 THEN システムはヘッダーに通知アイコン（🔔）を表示し、未読数バッジを含める

3. WHEN 通知インタラクション THEN システムは以下の通知操作機能を提供する：
   - 通知一覧の表示（最新5件のドロップダウン）
   - 個別通知の既読化
   - 優先度によるハイライト表示（high/normal/low）
   - アクションボタン（解約取り消し、決済方法変更等）

4. WHEN 通知データ管理 THEN システムは通知データを以下の仕様で管理する：
   - DynamoDB保存（notifications テーブル）
   - TTL自動削除（90日後）
   - 優先度別表示（高優先度を上位表示）
   - 有効期限管理（期限切れ通知の自動非表示）

### 9.2 決済状態通知機能

**ユーザーストーリー:** プレミアムユーザーとして、サブスクリプション状態の変更を確実に把握したい

#### 受入基準
1. WHEN サブスクリプション解約 THEN システムは期間末解約の詳細通知を作成する：
   - 解約予定日時の明示
   - 期間内利用可能の説明
   - 解約キャンセル可能の案内
   - アクションボタン：「解約をキャンセル」

2. WHEN 決済失敗 THEN システムは高優先度の緊急通知を作成する：
   - 問題の詳細説明（カード期限切れ、残高不足等）
   - 解決方法の案内
   - アクションボタン：「決済方法を更新」
   - 期限：1週間後に期限切れ

3. WHEN ログイン時状態同期 THEN システムはStripeとアプリDB状態を自動同期し、変更があれば通知作成する

## 10. Contact Service（お問い合わせ機能）

### 10.1 お問い合わせ受付システム

**ユーザーストーリー:** ユーザーとして、疑問や問題を適切にサポートチームに伝達したい

#### 受入基準
1. WHEN お問い合わせフォーム送信 THEN システムは以下の情報を収集・処理する：
   - 基本情報：名前、メールアドレス、件名、本文
   - カテゴリ分類：general/bug_report/feature_request/account_issue/payment/privacy/other
   - 優先度判定：low/medium/high（自動判定 + 手動選択）
   - 認証ユーザー情報：user_id（認証済みの場合自動設定）

2. WHEN セキュリティ・バリデーション THEN システムは以下のセキュリティ対策を実装する：
   - XSS対策：`<script>`, `javascript:`, イベントハンドラの検出
   - 入力制限：名前50文字/メール100文字/件名100文字/本文5000文字
   - スパム検出：疑わしいキーワード、過度のURL、文字繰り返しの検出
   - レート制限：1時間10件/日50件（IPベース）

3. WHEN 自動分類・優先度判定 THEN システムは以下の自動処理を実行する：
   - キーワードベースカテゴリ分類
   - 緊急キーワード検出による高優先度判定（「至急」「使えない」「エラー」等）
   - スパムスコア算出（0.8以上で低優先度に調整）

### 10.2 運営者通知システム

**ユーザーストーリー:** サービス管理者として、ユーザーからの問い合わせを迅速に把握し対応したい

#### 受入基準
1. WHEN お問い合わせ受信 THEN システムはAWS SNSを使用して運営者にメール通知を送信する：
   - 宛先：support@homebiyori.com, admin@homebiyori.com
   - 件名：優先度別の色分け（🟢低/🟡中/🔴高優先度）
   - 内容：基本情報、お客様情報、技術情報、対応指示を含む詳細情報

2. WHEN 通知内容 THEN システムは以下の構造化された通知を送信する：
   - 問い合わせID（UUID）、受信日時（JST）
   - カテゴリ・優先度・目標返信時間
   - お客様情報（名前、メール、ユーザー種別）
   - 技術情報（User-Agent、IP情報）
   - カテゴリ別対応指示（具体的なアクション項目）

3. WHEN 監視・アラート THEN システムは以下の監視機能を提供する：
   - CloudWatch統合：SNS配信成功率、問い合わせ数統計
   - 異常検知：1時間10件以上の問い合わせでDDoS検知アラート
   - Dead Letter Queue監視：配信失敗時の即座通知

## 11. バックエンドマイクロサービス構成

### 11.1 Lambda分割アーキテクチャ

**ユーザーストーリー:** 開発者として、保守性とスケーラビリティを考慮した効率的なバックエンド構成で開発したい

#### 受入基準
1. WHEN バックエンド構成 THEN システムは以下の機能別Lambda分割を採用する：
   - **chat-service** (1024MB, 60s): AI応答・チャット処理
   - **tree-service** (512MB, 30s): 木の成長管理
   - **user-service** (256MB, 15s): ユーザー管理
   - **billing-service** (512MB, 30s): Stripe課金管理
   - **webhook-service** (256MB, 15s): Stripe Webhook処理
   - **notification-service** (256MB, 15s): 通知管理
   - **contact-service** (256MB, 30s): 問い合わせ・サポート
   - **admin-service** (512MB, 30s): システム管理
   - **health-check** (128MB, 5s): 死活監視

2. WHEN API Gateway構成 THEN システムは認証レベルに応じた分離構成を提供する：
   - **prod-user-api**: エンドユーザー向け（Cognito認証）
   - **prod-admin-api**: 管理者向け（別Cognito User Pool）
   - 内部API: Lambda間通信用（内部認証キー）

3. WHEN Lambda間通信 THEN システムは以下のセキュアな通信パターンを実装する：
   - SQS経由非同期通信（webhook → ttl-updater）
   - 内部API経由HTTP通信（認証キー付き）
   - IAM Role認証による権限制御

### 11.2 Lambda Layers共通基盤

**ユーザーストーリー:** 開発者として、コードの重複を排除し、保守性の高い共通基盤で開発したい

#### 受入基準
1. WHEN 共通コード管理 THEN システムは**homebiyori-common-layer**で以下の共通機能を提供する：
   - DynamoDB統一クライアント（基本CRUD操作）
   - 構造化ログ（JSON形式、統一フォーマット）
   - 認証・JWT検証（Cognito統合）
   - JST時刻処理・入力検証・例外処理
   - メンテナンス制御ミドルウェア

2. WHEN サービス固有実装 THEN 各サービスの`database.py`と`models.py`は以下の責務を持つ：
   - **database.py**: ビジネスロジック特化のデータ操作
   - **models.py**: サービス固有Pydanticモデル・バリデーション
   - 共通Layerを基盤として活用し、サービス特有の複合処理を実装

3. WHEN 設計原則 THEN システムは以下の階層化アーキテクチャを採用する：
   ```
   homebiyori-common-layer ← 基盤機能
   ↓
   各サービス/database.py ← ビジネスロジック
   ↓  
   各サービス/handler.py ← APIエンドポイント
   ```

**注記:** 
- 個人情報保護の観点から、子供の個人情報（名前、生年月日等）の収集は行わない
- レスポンシブデザインによりモバイルファーストのUI/UX設計を採用
- 実装済み機能：感情アイコン6種類、チャットヘッダー、木の成長状態表示、ほめの実インタラクション
- **設計書完全準拠**: 本要件定義は各design.mdファイルの詳細仕様に基づいて作成されており、実装時は該当する設計書を参照すること
